<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<title>Tower Defense ‚Äì Enkel stabil versjon</title>
<style>
  body {
    margin: 0;
    background: #1e1e1e;
    color: white;
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  #ui {
    width: 100%;
    max-width: 900px;
    display: flex;
    justify-content: space-between;
    padding: 10px;
    background: #111;
  }
  button {
    background: #444;
    color: white;
    border: none;
    padding: 8px 12px;
    margin: 4px 0;
    cursor: pointer;
  }
  button:hover { background: #666; }
  canvas {
    background: #333;
    border: 2px solid white;
  }
  #overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }
</style>
</head>
<body>

<div id="ui">
  <div>
    <div id="stats"></div>
    <div id="waveInfo"></div>
    <div id="bestScore"></div>
    <button onclick="togglePause()">Pause</button>
  </div>
  <button onclick="startGame()">Start / Restart</button>
</div>

<canvas id="game" width="900" height="450"></canvas>

<div id="overlay">
  <h1>Game Over</h1>
  <p id="finalScore"></p>
  <button onclick="startGame()">Spill igjen</button>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let money, lives, score, wave, paused, gameRunning;
let enemies = [], towers = [], bullets = [];
let spawnTimer = 0;

const bestScoreKey = "td_best_score";
const path = [{x:0,y:225},{x:900,y:225}];

class Enemy {
  constructor(type) {
    this.type = type;
    this.pathIndex = 0;
    this.x = path[0].x;
    this.y = path[0].y;

    if (type === "fast") {
      this.hp = 30 + wave * 5;
      this.speed = 2.5;
      this.color = "orange";
      this.reward = 8;
    } else if (type === "tank") {
      this.hp = 120 + wave * 15;
      this.speed = 0.8;
      this.color = "purple";
      this.reward = 20;
    } else if (type === "boss") {
      this.hp = 500 + wave * 50;
      this.speed = 0.6;
      this.color = "gold";
      this.reward = 100;
    } else {
      this.hp = 60 + wave * 10;
      this.speed = 1.4;
      this.color = "red";
      this.reward = 10;
    }
  }

  update() {
    const target = path[this.pathIndex + 1];
    if (!target) {
      lives--;
      this.hp = 0;
      return;
    }
    const dx = target.x - this.x;
    const dy = target.y - this.y;
    const d = Math.hypot(dx, dy);
    if (d < this.speed) this.pathIndex++;
    else {
      this.x += dx / d * this.speed;
      this.y += dy / d * this.speed;
    }
  }

  draw() {
    ctx.fillStyle = this.color;
    ctx.fillRect(this.x-10, this.y-10, 20, 20);
    ctx.fillStyle = "lime";
    ctx.fillRect(this.x-10, this.y-15, 20*(this.hp/200), 3);
  }
}

class Tower {
  constructor(x,y) {
    this.x = x;
    this.y = y;
    this.range = 120;
    this.damage = 20;
    this.cooldown = 0;
  }

  update() {
    if (this.cooldown > 0) { this.cooldown--; return; }
    for (let e of enemies) {
      if (Math.hypot(e.x-this.x, e.y-this.y) < this.range) {
        bullets.push(new Bullet(this, e));
        this.cooldown = 30;
        break;
      }
    }
  }

  draw() {
    ctx.fillStyle = "blue";
    ctx.beginPath();
    ctx.arc(this.x,this.y,12,0,Math.PI*2);
    ctx.fill();
  }
}

class Bullet {
  constructor(t,e) {
    this.x=t.x; this.y=t.y;
    this.e=e; this.speed=5; this.d=t.damage;
    this.dead=false;
  }

  update() {
    if (!this.e || this.e.hp<=0) { this.dead=true; return; }
    const dx=this.e.x-this.x, dy=this.e.y-this.y;
    const d=Math.hypot(dx,dy);
    if (d<5) {
      this.e.hp-=this.d;
      if (this.e.hp<=0) {
        money+=this.e.reward;
        score+=this.e.reward;
      }
      this.dead=true;
    } else {
      this.x+=dx/d*this.speed;
      this.y+=dy/d*this.speed;
    }
  }

  draw() {
    ctx.fillStyle="yellow";
    ctx.beginPath();
    ctx.arc(this.x,this.y,4,0,Math.PI*2);
    ctx.fill();
  }
}

function startGame() {
  money=100; lives=10; score=0; wave=1;
  enemies=[]; towers=[]; bullets=[];
  paused=false; gameRunning=true;
  document.getElementById("overlay").style.display="none";
  loop();
}

function spawnWave() {
  if (spawnTimer++ % 60 !== 0) return;

  if (wave % 5 === 0) {
    enemies.push(new Enemy("boss"));
  } else {
    enemies.push(new Enemy("normal"));
    if (wave>2) enemies.push(new Enemy("fast"));
    if (wave>4) enemies.push(new Enemy("tank"));
  }
}

function togglePause() { paused=!paused; }

function loop() {
  if (!gameRunning) return;

  if (!paused) {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    ctx.strokeStyle="#555"; ctx.lineWidth=40;
    ctx.beginPath(); ctx.moveTo(path[0].x,path[0].y);
    ctx.lineTo(path[1].x,path[1].y); ctx.stroke();

    spawnWave();

    enemies.forEach(e=>e.update());
    towers.forEach(t=>t.update());
    bullets.forEach(b=>b.update());

    enemies=enemies.filter(e=>e.hp>0);
    bullets=bullets.filter(b=>!b.dead);

    enemies.forEach(e=>e.draw());
    towers.forEach(t=>t.draw());
    bullets.forEach(b=>b.draw());

    if (enemies.length===0) wave++;

    document.getElementById("stats").innerText=`üí∞ ${money} ‚ù§Ô∏è ${lives} ‚≠ê ${score}`;
    document.getElementById("waveInfo").innerText=`B√∏lge ${wave}`;

    if (lives<=0) endGame();
  }
  requestAnimationFrame(loop);
}

function endGame() {
  gameRunning=false;
  const best = Math.max(score, localStorage.getItem(bestScoreKey)||0);
  localStorage.setItem(bestScoreKey,best);
  document.getElementById("finalScore").innerText=`Score: ${score}`;
  document.getElementById("overlay").style.display="flex";
}

canvas.addEventListener("pointerdown", e => {
  const r=canvas.getBoundingClientRect();
  const x=e.clientX-r.left, y=e.clientY-r.top;

  if (money>=50) {
    towers.push(new Tower(x,y));
    money-=50;
  }
});
</script>
</body>
</html>

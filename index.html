<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ultimate Idle Tower Defense</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    margin: 0;
    background: #111;
    color: #eee;
    font-family: Arial, sans-serif;
}

#ui {
    position: fixed;
    top: 0;
    width: 100%;
    background: rgba(0,0,0,0.9);
    padding: 10px;
    z-index: 10;
}

button {
    margin: 4px;
    padding: 6px 12px;
    background: #444;
    color: #eee;
    border: 1px solid #666;
    border-radius: 5px;
    cursor: pointer;
}

button:hover { background: #666; }

#gameContainer {
    margin-top: 200px;
    display: flex;
    justify-content: center;
}

canvas {
    background: #222;
    border: 2px solid #555;
}

#overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    font-size: 32px;
}
</style>
</head>

<body>

<div id="ui">
    <div>
        Gold: <span id="gold">0</span> |
        Wave: <span id="wave">1</span> |
        Prestige: <span id="prestige">0</span>
    </div>

    <div>
        <button onclick="selectTower('basic')">Basic (50)</button>
        <button onclick="selectTower('sniper')">Sniper (150)</button>
        <button onclick="selectTower('cannon')">Cannon (300)</button>
    </div>

    <div>
        <strong>Skills:</strong>
        <button onclick="upgrade('damage')">Damage +</button>
        <button onclick="upgrade('fireRate')">Fire Rate +</button>
        <button onclick="upgrade('range')">Range +</button>
    </div>

    <div>
        <button onclick="prestigeReset()">Prestige</button>
    </div>
</div>

<div id="gameContainer">
    <canvas id="game" width="900" height="500"></canvas>
</div>

<div id="overlay">
    <div>GAME OVER</div>
    <button onclick="restart()">Restart</button>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const gridSize = 50;
const pathY = Math.floor(canvas.height / gridSize / 2) * gridSize + gridSize / 2;

let gold = 100;
let wave = 1;
let prestige = Number(localStorage.getItem("prestige")) || 0;

let selectedTower = null;
let gameOver = false;

const enemies = [];
const towers = [];
const bullets = [];

const skills = JSON.parse(localStorage.getItem("skills")) || {
    damage: 1,
    fireRate: 1,
    range: 1
};

const towerTypes = {
    basic: { cost: 50, damage: 20, fireRate: 1, range: 120 },
    sniper: { cost: 150, damage: 60, fireRate: 0.5, range: 250 },
    cannon: { cost: 300, damage: 120, fireRate: 0.25, range: 150 }
};

/* ---------- IDLE PROGRESS ---------- */
const lastTime = Number(localStorage.getItem("lastTime"));
if (lastTime) {
    const secondsAway = Math.floor((Date.now() - lastTime) / 1000);
    gold += Math.min(secondsAway * 2, 5000);
}
updateUI();

/* ---------- GRID CLICK ---------- */
canvas.addEventListener("click", e => {
    if (!selectedTower || gameOver) return;
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) / gridSize) * gridSize + gridSize/2;
    const y = Math.floor((e.clientY - rect.top) / gridSize) * gridSize + gridSize/2;
    if (Math.abs(y - pathY) < gridSize) return;

    const t = towerTypes[selectedTower];
    if (gold < t.cost) return;

    gold -= t.cost;
    towers.push({
        x, y,
        ...t,
        cooldown: 0
    });
    updateUI();
});

/* ---------- GAME LOGIC ---------- */
function spawnWave() {
    for (let i = 0; i < 6 + wave; i++) {
        enemies.push({
            x: -i * 60,
            y: pathY,
            hp: 100 + wave * 25,
            maxHp: 100 + wave * 25,
            speed: 0.6 + wave * 0.05
        });
    }
    document.getElementById("wave").textContent = wave;
    wave++;
}

function update(dt) {
    if (gameOver) return;

    enemies.forEach(e => {
        e.x += e.speed;
        if (e.x > canvas.width) endGame();
    });

    towers.forEach(t => {
        t.cooldown -= dt;
        if (t.cooldown <= 0) {
            const target = enemies.find(e =>
                Math.hypot(e.x - t.x, e.y - t.y) <
                t.range * skills.range
            );
            if (target) {
                bullets.push({
                    x: t.x,
                    y: t.y,
                    target,
                    speed: 6,
                    damage: t.damage * skills.damage * (1 + prestige * 0.1)
                });
                t.cooldown = 1 / (t.fireRate * skills.fireRate);
            }
        }
    });

    bullets.forEach(b => {
        const dx = b.target.x - b.x;
        const dy = b.target.y - b.y;
        const d = Math.hypot(dx, dy);
        if (d < 5) {
            b.target.hp -= b.damage;
            b.hit = true;
            if (b.target.hp <= 0) {
                gold += 10;
                enemies.splice(enemies.indexOf(b.target), 1);
                updateUI();
                if (!enemies.length) spawnWave();
            }
        } else {
            b.x += dx / d * b.speed;
            b.y += dy / d * b.speed;
        }
    });

    for (let i = bullets.length - 1; i >= 0; i--) {
        if (bullets[i].hit) bullets.splice(i, 1);
    }
}

function render() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    ctx.strokeStyle = "#444";
    ctx.lineWidth = 6;
    ctx.beginPath();
    ctx.moveTo(0, pathY);
    ctx.lineTo(canvas.width, pathY);
    ctx.stroke();

    for (let x=0;x<canvas.width;x+=gridSize){
        for (let y=0;y<canvas.height;y+=gridSize){
            ctx.strokeStyle="#333";
            ctx.strokeRect(x,y,gridSize,gridSize);
        }
    }

    towers.forEach(t=>{
        ctx.fillStyle="cyan";
        ctx.beginPath();
        ctx.arc(t.x,t.y,10,0,Math.PI*2);
        ctx.fill();
    });

    enemies.forEach(e=>{
        ctx.fillStyle="red";
        ctx.fillRect(e.x-12,e.y-12,24,24);
        ctx.fillStyle="lime";
        ctx.fillRect(e.x-12,e.y-18,24*(e.hp/e.maxHp),4);
    });

    bullets.forEach(b=>{
        ctx.fillStyle="yellow";
        ctx.beginPath();
        ctx.arc(b.x,b.y,3,0,Math.PI*2);
        ctx.fill();
    });
}

/* ---------- UI & META ---------- */
function selectTower(t){ selectedTower=t; }
function upgrade(s){ if(gold>=100){ gold-=100; skills[s]+=0.2; save(); updateUI(); }}
function prestigeReset(){
    prestige++;
    localStorage.setItem("prestige",prestige);
    restart();
}
function updateUI(){
    gold=Math.floor(gold);
    document.getElementById("gold").textContent=gold;
    document.getElementById("prestige").textContent=prestige;
}
function save(){
    localStorage.setItem("skills",JSON.stringify(skills));
}
function endGame(){
    gameOver=true;
    document.getElementById("overlay").style.display="flex";
}
function restart(){
    enemies.length=0;
    towers.length=0;
    bullets.length=0;
    gold=100;
    wave=1;
    gameOver=false;
    document.getElementById("overlay").style.display="none";
    updateUI();
    spawnWave();
}

let last=0;
function loop(t){
    const dt=(t-last)/1000;
    last=t;
    update(dt);
    render();
    requestAnimationFrame(loop);
}

spawnWave();
loop(0);

window.addEventListener("beforeunload",()=>{
    localStorage.setItem("lastTime",Date.now());
    save();
});
</script>

</body>
</html>
